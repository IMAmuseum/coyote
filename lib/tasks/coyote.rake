namespace :coyote do
  desc "Checks for new MCA images"
  task :update_mca => :environment do

    require 'multi_json'
    require 'open-uri'

    @website = Website.first
    limit = 1000
    offset = 0
    if Image.all.count > 10 #kludge
      updated_at = (Time.zone.now - 1.minute).iso8601
    else
      updated_at = nil
    end

    length = 1
    root = "https://cms.mcachicago.org"
    updated = 0
    created = 0
    errors = 0
    while length != 0 do
      #some images have a null updated at
      if updated_at
        url = root + "/api/v1/attachment_images?updated_at=#{updated_at}&offset=#{offset}&limit=#{limit}"
      else
        url = root + "/api/v1/attachment_images?offset=#{offset}&limit=#{limit}"
      end
      Rails.logger.info "grabbing images for #{url}"

      begin
        content = open(url, { "Content-Type" => "application/json", ssl_verify_mode: OpenSSL::SSL::VERIFY_NONE}).read
      rescue OpenURI::HTTPError => error
        response = error.io
        Rails.logger.error response.string
        length = 0
      end
      begin
        images = JSON.parse(content)
      rescue Exception => e
        Rails.logger.error "JSON parsing exception"
        length = 0
      end

      length = images.length

      Rails.logger.info "length is #{length}"
      Rails.logger.info "Created: #{created}"
      Rails.logger.info "Updated: #{updated}"
      Rails.logger.info "Errors: #{errors}"
      Rails.logger.info "Total: #{errors + updated + created}"
      Rails.logger.info "Our total: #{@website.images.count}"


      images.each do |i|
        begin
          image = Image.find_or_create_by(canonical_id:  i["id"], website: @website)
          if image.new_record?
            image.website = @website
            group = Group.find_or_create_by(title: i["group"])
            group.save if group.new_record?
            image.group = group
            image.path = i["thumb_url"]
            image.created_at = i["created_at"]
            image.updated_at = i["updated_at"]
            image.save
            #create initial description field
            Rails.logger.info "created image #{image.id} from canonical id #{image.canonical_id}"
            created += 1
          else
            #update
            image.path = i["thumb_url"]
            image.updated_at = i["updated_at"]
            if image.save
              Rails.logger.info "updated image #{image.id} from canonical id #{image.canonical_id}"
              updated += 1
            else
              Rails.logger.error "save failed"
              errors += 1
            end
          end
          #create description if none are handy
          if image.descriptions.length == 0  and !i["title"].blank?
            d = Description.new(text: i["title"], locale: "en", metum_id: 1, image_id: image.id, status_id: 1, user_id: 1)
            if d.save
              Rails.logger.info "description #{d.id} for image #{image.id} saved"
            else
              Rails.logger.error "description save failed"
            end
          end

        rescue Exception => e
          Rails.logger.error "image creation error"
          Rails.logger.error i
          Rails.logger.error e
          errors += 1
        end
      end

      offset += limit
    end

    Rails.logger.info "--- Totals for #{Time.now} ---"
    Rails.logger.info "Created: #{created}"
    Rails.logger.info "Updated: #{updated}"
    Rails.logger.info "Errors: #{errors}"
    Rails.logger.info "Total: #{errors + updated + created}"
    Rails.logger.info "Our total: #{@website.images.count}"
    Rails.logger.info "---"

  end
end


#debugging
#require 'multi_json'
#require 'open-uri'
#root = "https://cms.mcachicago.org"

#ids = [
#'55917aaa613430007400002b', '55917aae6134300074000111', '55917aae6134300074000114', '55917aae6134300074000117', '55917aae613430007400011a', '55917aaf613430007400011d', '55917aaf6134300074000120', '55917ab06134300074000150', '55917ab1613430007400015b', '55917ab16134300074000165', '55917ab16134300074000168', '55917ab261343000740001b3', '55917ab261343000740001b6', '55917ab261343000740001b9', '55917ab261343000740001bc', '55917ab861343000740002f0', '55917ab96134300074000314', '55917abb6134300074000334', '55917abb6134300074000337', '55917abb613430007400033a', '55917ac161343000740003ab', '55917ac461343000740003f7', '55917ac461343000740003fa', '55917ac461343000740003fd', '55917ac46134300074000400', '55917ac4613430007400040a', '55917ac4613430007400040e', '55917ac56134300074000411', '55917ace6134300074000550', '55917ace6134300074000553', '55917ace6134300074000556', '55917ace6134300074000559', '55917ace613430007400055c', '55917ace613430007400055f', '55917acf6134300074000569', '55917acf613430007400056c', '55917acf613430007400056f', '55917acf6134300074000572', '55917acf6134300074000575', '55917acf6134300074000578', '55917ae561343000740006a3', '55917af861343000740007a2', '55917af861343000740007a5', '55917af861343000740007a8', '55917af861343000740007ab', '55917af861343000740007ae', '55917af961343000740007b1', '55917af961343000740007b4', '55917af961343000740007b9', '55917afa61343000740007bd', '55917afa61343000740007c1', '55917b4e6134300074000cb7', '55917b4f6134300074000cdf', '55917b4f6134300074000ce3', '55917b506134300074000d22', '55917b506134300074000d26', '55917b516134300074000d2b', '55917b516134300074000d2f', '55917b516134300074000d33', '55917b526134300074000d37', '55917b536134300074000d68', '55917b6d6134300074000ef9', '55917b6f6134300074000f5a', '55917b716134300074000fa5', '55917b8261343000740010b9', '55917b8361343000740010bc', '55917b8361343000740010bf', '55917b8361343000740010c2', '55917b8361343000740010c5', '55917b8361343000740010c8', '55917b8361343000740010cb', '55917b8361343000740010ce', '55917b8361343000740010d1', '55917b8461343000740010d4', '55917b8461343000740010d7', '55917b8461343000740010da', '55917b8461343000740010dd', '55917b8461343000740010e0', '55917b8461343000740010e3', '55917b8461343000740010e6', '55917b8461343000740010e9', '55917b8461343000740010ec', '55917b8461343000740010ef', '55917b8461343000740010f2', '55917b8561343000740010f5', '55917b8561343000740010f8', '55917b8561343000740010fb', '55917b8561343000740010fe', '55917b856134300074001101', '55917b856134300074001104', '55917b856134300074001107', '55917b85613430007400110a', '55917b86613430007400110d', '55917b866134300074001110', '55917b866134300074001113', '55917b866134300074001116', '55917b866134300074001119', '55917b86613430007400111c', '55917b86613430007400111f', '55917b866134300074001122', '55917b866134300074001125', '55917b866134300074001128', '55917b87613430007400112b', '55917b87613430007400112e', '55917b876134300074001131', '55917b876134300074001134', '55917b876134300074001137', '55917b87613430007400113a', '55917b88613430007400113d', '55917b886134300074001140', '55917b886134300074001143', '55917b886134300074001146', '55917b886134300074001149', '55917b88613430007400114c', '55917b88613430007400114f', '55917b886134300074001152', '55917b886134300074001155', '55917b886134300074001158', '55917b88613430007400115b', '55917b89613430007400115e', '55917b896134300074001161', '55917b896134300074001164', '55917b8f61343000740011c6', '55917bf86134300074001698', '55917bf9613430007400169c', '55917c366134300074001be7', '55917c4e6134300074001f02', '55917c526134300074001f7c', '55917c596134300074002039', '55917c6c61343000740021f3', '55917c6c61343000740021f6', '55917c6c61343000740021f9', '55917c6c61343000740021fc', '55917c6c61343000740021ff', '55917c6c6134300074002202', '55917c6c6134300074002205', '55917c6d6134300074002208', '55917c6d613430007400220b', '55917c6d613430007400220e', '55917c6d6134300074002211', '55917c6d6134300074002214', '55917c6d6134300074002217', '55917c6d613430007400221a', '55917c6d613430007400221d', '55917c6e6134300074002220', '55917c6e6134300074002223', '55917c6e6134300074002226', '55917c6e6134300074002229', '55917c6e613430007400222c', '55917c6e613430007400222f', '55917c6e6134300074002232', '55917c6f6134300074002235', '55917c6f6134300074002238', '55917c6f613430007400223b', '55917c6f613430007400223e', '55917c6f6134300074002241', '55917c6f6134300074002244', '55917c6f6134300074002247', '55917c6f613430007400224a', '55917c6f613430007400224d', '55917c706134300074002250', '55917c706134300074002253', '55917c706134300074002256', '55917c706134300074002259', '55917c70613430007400225c', '55917c70613430007400225f', '55917c706134300074002262', '55917c706134300074002265', '55917c706134300074002268', '55917c70613430007400226b', '55917c70613430007400226e', '55917c706134300074002271', '55917c706134300074002274', '55917c706134300074002277', '55917c71613430007400227a', '55917c7b61343000740023a4', '55917c7d61343000740023b0', '55917c7d61343000740023b3', '55917c7d61343000740023b6', '55917c7d61343000740023b9', '55917c97613430007400257e', '55917c976134300074002581', '55917c976134300074002584', '55917c976134300074002587', '55917c97613430007400258a', '55917c98613430007400258d', '55917c986134300074002590', '55917c986134300074002593', '55917c986134300074002596', '55917c986134300074002599', '55917c98613430007400259c', '55917c99613430007400259f', '55917c9961343000740025a2', '55917c9961343000740025a5', '55917c9d613430007400261b', '55917c9d613430007400261f', '55917c9d613430007400262d', '55917cc061343000740028e7', '55917cc46134300074002945', '55917cc46134300074002948', '55917cc5613430007400294b', '55917cc5613430007400294e', '55917cc66134300074002951', '55917cc66134300074002954', '55917cc76134300074002957', '55917cc86134300074002960', '55917cc861343000740029c5', '55917cc861343000740029c8', '55917cc861343000740029cb', '55917ccb61343000740029d2', '55917cd06134300074002a59', '55917cd06134300074002a5c', '55917cd06134300074002a62', '55917cd06134300074002a65', '55917cd16134300074002a68', '55917cd16134300074002a6b', '55917cd16134300074002a6e', '55917cd16134300074002a71', '55917cd16134300074002a74', '55917cd16134300074002a77', '55917cd16134300074002a7a', '55917cd16134300074002a7d', '55917cd16134300074002a80', '55917cd16134300074002a83', '55917cd16134300074002a86', '55917cd46134300074002ab0', '559191f06332640b96000d88', '559191f06332640b96000d91', '559191f06332640b96000d9a', '559191f16332640b96000da4', '559191f16332640b96000dad', '559191f16332640b96000db7', '559191f16332640b96000dca', '559191f16332640b96000dd3', '559191f16332640b96000ddc', '559191f26332640b96000dea', '559191f36332640b96000dfa', '559191f36332640b96000e03', '559191f36332640b96000e0d', '559191f46332640b96000e16', '559191f46332640b96000e1f', '559191f46332640b96000e28', '559191f46332640b96000e2b', '559191f46332640b96000e35', '559191f46332640b96000e3e', '559191f56332640b96000e48', '559191f56332640b96000e51', '559191f56332640b96000e5a', '559191f66332640b96000e66', '559191f66332640b96000e70', '559191f76332640b96000e7e', '559191f76332640b96000e89', '559191f76332640b96000e92', '559191f86332640b96000e9c', '559191f86332640b96000ea5', '559191f86332640b96000eae', '559191f86332640b96000eb7', '559191f96332640b96000ec2', '559191f96332640b96000ecb', '559191f96332640b96000ed4', '559191f96332640b96000ee2', '559191f96332640b96000eeb', '559191fa6332640b96000ef9', '559191fa6332640b96000f02', '559191fa6332640b96000f0b', '559191fa6332640b96000f1e', '559191fa6332640b96000f27', '559191fb6332640b96000f36', '559191fb6332640b96000f3f', '559191fb6332640b96000f48', '559191fb6332640b96000f51', '559191fb6332640b96000f5c', '559191fc6332640b96000f65', '559191fc6332640b96000f73', '559191fc6332640b96000f82', '559191fc6332640b96000f8b', '559191fc6332640b96000f94', '559191fc6332640b96000fa2', '559191fd6332640b96000fbd', '559191fd6332640b96000fc4', '559191fe6332640b96000fca', '559191fe6332640b96000fd5', '559191fe6332640b96000fe3', '559191ff6332640b96000fec', '559191ff6332640b96000ff0', '559191ff6332640b96000ff3', '559192006332640b96000ff7', '559192006332640b96000ffb', '559192006332640b96000fff', '559192006332640b96001003', '559192006332640b96001006', '559192006332640b96001009', '559192016332640b9600100c', '559192016332640b9600100f', '559192016332640b96001013', '559192016332640b96001017', '559192016332640b9600101a', '559192036332640b96001023', '559192036332640b96001026', '559192036332640b96001029', '559192036332640b9600102d', '559192036332640b96001030', '559192036332640b96001033', '559192046332640b96001036', '559192046332640b9600103a', '559192046332640b9600103d', '559192046332640b96001040', '559192046332640b96001044', '559192056332640b96001047', '559192056332640b9600104a', '559192066332640b9600104e', '559192066332640b96001055', '559192076332640b96001058', '559192076332640b9600105b', '559192076332640b9600105e', '559192076332640b96001061', '559192076332640b96001064', '559192076332640b96001067', '559192076332640b9600106a', '559192076332640b9600106d', '559192076332640b96001070', '559192076332640b96001073', '559192086332640b96001076', '559192086332640b96001079', '559192086332640b9600107d', '5591920a6332640b96001081', '5591920e6332640b96001085', '5591920e6332640b96001088', '5591920e6332640b9600108b', '5591920f6332640b9600108e', '5591920f6332640b96001091', '5591920f6332640b96001094', '5591920f6332640b96001098', '5591920f6332640b9600109c', '559192116332640b960010d7', '559192116332640b960010e0', '559192116332640b960010ea', '559192116332640b960010f8', '559192116332640b96001101', '559192116332640b9600110a', '559192116332640b96001113', '559192136332640b96001120', '559192136332640b9600112a', '559192136332640b96001133', '559192136332640b9600113c', '559192136332640b9600113f', '559192136332640b96001143', '559192136332640b9600114e', '559192146332640b96001157', '559192146332640b96001161', '559192146332640b9600116a', '559192146332640b96001178', '559192146332640b96001181', '559192146332640b9600118a', '559192156332640b96001194', '559192156332640b9600119e', '559192156332640b960011ac', '559192156332640b960011b5', '559192156332640b960011be', '559192156332640b960011c7', '559192166332640b960011d0', '559192166332640b960011d9', '559192166332640b960011e2', '559192166332640b960011eb', '559192166332640b960011f9', '559192166332640b96001207', '559192166332640b96001210', '559192176332640b9600121b', '559192176332640b96001224', '559192176332640b9600122d', '559192176332640b96001240', '559192176332640b96001249', '559192176332640b96001252', '559192176332640b9600125b', '559192176332640b96001264', '559192186332640b9600126e', '559192186332640b9600127c', '559192186332640b96001285', '559192186332640b96001293', '559192186332640b9600129d', '559192186332640b960012a6', '559192186332640b960012b1', '559192186332640b960012b4', '559192186332640b960012b7', '559192186332640b960012bb', '559192196332640b960012be', '559192196332640b960012c1', '559192196332640b960012c4', '559192196332640b960012c7', '559192196332640b960012ca', '5591921a6332640b960012cd', '5591921a6332640b960012d0', '5591921a6332640b960012d3', '5591921a6332640b960012d7', '5591921a6332640b960012da', '5591921a6332640b960012dd', '5591921a6332640b960012e0', '5591921b6332640b960012e3', '5591921b6332640b960012e6', '5591921b6332640b960012e9', '5591921b6332640b960012ec', '5591921c6332640b960012ef', '5591921c6332640b960012f2', '5591921c6332640b960012f5', '5591921c6332640b960012f9', '5591921c6332640b960012fc', '5591921c6332640b96001300', '5591921e6332640b960014d8', '5591921e6332640b960014db', '5591921e6332640b960014de', '5591921f6332640b960014e5', '5591921f6332640b960014e8', '5591921f6332640b960014eb', '5591921f6332640b960014ee', '5591921f6332640b960014f1', '559192206332640b960014f4', '559192206332640b960014f8', '559192206332640b960014fb', '559192206332640b960014fe', '559192206332640b96001501', '559192216332640b96001505', '559192216332640b96001508', '559192216332640b9600150b', '559192216332640b9600150e', '559192216332640b96001511', '559192226332640b96001518', '559192236332640b9600151b', '559192236332640b9600151e', '559192236332640b96001522', '559192236332640b96001526', '559192246332640b9600152a', '559192246332640b9600152e', '559192246332640b96001531', '559192246332640b96001534', '559192246332640b96001537', '559192256332640b9600153c', '559192256332640b96001541', '559192256332640b96001545', '559192256332640b96001548', '559192256332640b9600154b', '559192256332640b9600154e', '559192266332640b96001552', '559192286332640b960016d7', '559232263835390045000002', '5596a72935313200490000ce', '5596b6e4353132004c000134', '5596b79c353132004c000147', '559a3c0f3732320048000016', '559a3c373732320045000013', '559a3c7b373232003f000019', '559a3ca9373232003f00001f', '559a3cc0373232004800001d', '559a3cd7373232003f000023', '559a3ceb3732320048000023', '559a3d00373232004500001e', '559a3d1f373232003d000024', '559a3d2e3732320042000015', '559a3dab373232003d00002b', '559a3f38373232003f000032', '559a3f943732320048000029', '559a400d373232003f000045', '559a4043373232004500003e', '559a4098373232003f000049', '559a40f8373232003f00004d', '559a41443732320048000031', '559a41d5373232004200001e', '559a42383732320048000039', '559a427d3732320045000048', '559a42ac3732320048000040', '559a433c373232003d000043', '559a434d373232003f000059', '559a4401373232003d000046', '559a4418373232004800004a', '559a441e373232003d00004a', '559a4684373232003f000065', '559a4692373232004800004e', '559a48dc3732320042000030', '559a48e6373232003f000069', '559a4a913732320042000035', '559a4cb1373232003d00004f', '559a4d83373232003d000057', '559a4d93373232004200003c', '559a4da63732320042000042']

#ids.each do |id|
  #url = root + "/api/v1/attachment_images/" + id
  #content = open(url, { "Content-Type" => "application/json", ssl_verify_mode: OpenSSL::SSL::VERIFY_NONE}).read
  #i = JSON.parse(content)
  #image = Image.find_or_create_by(canonical_id:  i["id"])
  #@website = Website.first
  #if image.new_record?
    #image.website = @website
    #group = Group.find_or_create_by(title: i["group"])
    #group.save if group.new_record?
    #image.group = group
    #image.path = i["thumb_url"]
    #image.created_at = i["created_at"]
    #image.updated_at = i["updated_at"]
    #image.save
    ##create initial description field
    #Rails.logger.info "created image #{image.id} from canonical id #{image.canonical_id}"
  #else
    ##update
    #image.path = i["thumb_url"]
    #image.updated_at = i["updated_at"]
    #image.save
    #Rails.logger.info "updated image #{image.id} from canonical id #{image.canonical_id}"
  #end
  ##create description if none are handy
  #if image.descriptions.length == 0  and !i["title"].blank?
    #d = Description.new(text: i["title"], locale: "en", metum_id: 1, image_id: image.id, status_id: 1, user_id: 1)
    #d.save!
    #Rails.logger.info "description #{d.id} for image #{image.id} saved"
  #end
#end
#offset += limit
#url = root + "/api/v1/attachment_images?updated_at=#{updated_at}&offset=#{offset}&limit=#{limit}"
#content = open(url, { "Content-Type" => "application/json", ssl_verify_mode: OpenSSL::SSL::VERIFY_NONE}).read
#images = JSON.parse(content)
#images.detect{|i| i["id"] =="55917aaa6134300074000028"}
